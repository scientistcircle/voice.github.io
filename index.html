// --- FUNGSI AUDIO FIX ---
    async function putar(url) {
        return new Promise((resolve) => {
            console.log("Sedang memutar:", url); // Cek di Console (F12)
            audio.src = url;
            
            // Penting: Reset audio agar bisa diputar ulang
            audio.load(); 

            audio.play().then(() => {
                viz.classList.add("active");
            }).catch(e => {
                console.error("Gagal putar! Klik layar dulu.", e);
                resolve();
            });

            audio.onended = () => {
                viz.classList.remove("active");
                resolve();
            };

            audio.onerror = (e) => {
                console.error("File tidak ditemukan atau error:", url);
                viz.classList.remove("active");
                resolve(); // Tetap lanjut ke antrean berikutnya
            };
        });
    }

    async function play() {
        // WAJIB: Bangunkan Audio Context (Izin browser)
        bangunkanAudio();

        const s = document.getElementById("sholat").value;
        const q = document.getElementById("qab").value;
        if(!s || !q) return alert("Pilih sholat & isi nama!");

        btnPlay.disabled = true;
        btnPlay.innerText = "SEDANG DISIARKAN...";

        let l = document.getElementById("lokasi").value;
        
        // Buat daftar antrean
        let queue = [];
        queue.push("audio/bel.mp3");

        if(s==="subuh") {
            queue.push("audio/subuh.mp3");
            queue.push(q);
        } else if(s==="dzuhur") {
            queue.push("audio/dzuhur_qab.mp3");
            queue.push(q);
            queue.push("audio/dzuhur_bad.mp3");
            queue.push(document.getElementById("bad").value);
        } else if(s==="ashar" || s==="maghrib") {
            queue.push(`audio/${s}.mp3`);
            queue.push(l === "Lantai 1" ? "audio/lantai1.mp3" : "audio/lantai2.mp3");
            queue.push(q);
        } else if(s==="isya") {
            queue.push("audio/isya_qab.mp3");
            queue.push(l === "Lantai 1" ? "audio/lantai1.mp3" : "audio/lantai2.mp3");
            queue.push(q);
            queue.push("audio/isya_bad.mp3");
            queue.push(l === "Lantai 1" ? "audio/lantai1.mp3" : "audio/lantai2.mp3");
            queue.push(document.getElementById("bad").value);
        }

        queue.push("audio/penutup.mp3");

        // Proses antrean satu per satu
        for (let item of queue) {
            if (!item) continue;
            let finalPath = item.endsWith(".mp3") ? item : getTTSUrl(item);
            await putar(finalPath);
            await new Promise(r => setTimeout(r, 500)); // Jeda antar suara
        }

        btnPlay.disabled = false;
        btnPlay.innerText = "â–¶ Siarkan Pengumuman";
        tambahLog(s, q);
    }
