<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Announcement Santri - SMA Sains Al-Qur'an</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4facfe;
            --secondary: #00f2fe;
            --bg-gradient: linear-gradient(135deg, #0a2540 0%, #0f3c66 50%, #145ea8 100%);
            --glass: rgba(255, 255, 255, 0.12);
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body {
            margin: 0; min-height: 100vh;
            background: var(--bg-gradient);
            display: flex; justify-content: center; align-items: center; 
            color: white; padding: 20px;
        }

        .main-wrapper {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 25px;
            width: 100%;
            max-width: 1250px;
            align-items: start;
        }

        .datetime-display {
            grid-column: span 2;
            text-align: right;
            margin-bottom: 10px;
        }
        #realtime-date { font-size: 14px; opacity: 0.8; margin: 0; }
        #realtime-clock { font-size: 32px; font-weight: 700; margin: 0; color: var(--secondary); letter-spacing: 2px; }

        .card, .log-section {
            background: var(--glass); backdrop-filter: blur(20px);
            border-radius: 30px; border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 25px 50px rgba(0,0,0,0.4);
        }

        .card { padding: 40px; }

        .header { text-align: center; margin-bottom: 30px; }
        .logo-wrap { width: 70px; height: 70px; margin: 0 auto 15px; border-radius: 50%; background: white; padding: 5px; }
        .logo-wrap img { width: 100%; height: 100%; border-radius: 50%; object-fit: contain; }

        .voice-indicator {
            display: flex; justify-content: center; align-items: center; gap: 5px; height: 20px; opacity: 0;
        }
        .voice-indicator.active { opacity: 1; }
        .bar { width: 3px; height: 10px; background: var(--secondary); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { height: 5px; } 50% { height: 20px; } }

        .adzan { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 30px; }
        .adzan-item { background: rgba(0,0,0,0.2); padding: 12px 5px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .adzan-item span { font-size: 10px; display: block; opacity: 0.7; margin-bottom: 5px; text-transform: uppercase; }
        .adzan-item b { font-size: 15px; color: var(--secondary); }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .input-group { position: relative; grid-column: span 2; }
        
        input, select {
            width: 100%; padding: 15px; border-radius: 12px; border: none; outline: none;
            background: white; color: #333; font-weight: 600; font-size: 15px;
        }

        .btn-test {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: #f0f0f0; border: none; padding: 6px 12px; border-radius: 8px;
            font-size: 11px; cursor: pointer; color: #555; font-weight: 700;
        }

        button#mainPlay {
            margin-top: 25px; width: 100%; padding: 20px; border-radius: 15px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: #0a2540; font-weight: 800; border: none; cursor: pointer;
            text-transform: uppercase; font-size: 16px; transition: 0.3s;
        }
        button#mainPlay:disabled { opacity: 0.6; }

        .log-section { padding: 30px; align-self: stretch; display: flex; flex-direction: column; }
        .log-container { overflow-y: auto; flex-grow: 1; max-height: 500px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        td { padding: 12px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .badge { background: var(--primary); color: #0a2540; padding: 2px 6px; border-radius: 4px; font-weight: 700; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="datetime-display">
        <p id="realtime-date">...</p>
        <p id="realtime-clock">00:00:00</p>
    </div>

    <div class="card">
        <div class="header">
            <div class="logo-wrap"><img src="logo.png" alt="Logo"></div>
            <h2 style="margin:0; font-size: 20px;">SMA SAINS AL-QUR'AN</h2>
            <div class="voice-indicator" id="viz">
                <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
            </div>
        </div>

        <div class="adzan">
            <div class="adzan-item"><span>Subuh</span><b id="t-fajr">--:--</b></div>
            <div class="adzan-item"><span>Dzuhur</span><b id="t-dhuhr">--:--</b></div>
            <div class="adzan-item"><span>Ashar</span><b id="t-asr">--:--</b></div>
            <div class="adzan-item"><span>Maghrib</span><b id="t-maghrib">--:--</b></div>
            <div class="adzan-item"><span>Isya</span><b id="t-isha">--:--</b></div>
        </div>

        <div class="form-grid">
            <select id="sholat" onchange="aturForm()">
                <option value="">-- Pilih Sholat --</option>
                <option value="subuh">Subuh</option>
                <option value="dzuhur">Dzuhur</option>
                <option value="ashar">Ashar</option>
                <option value="maghrib">Maghrib</option>
                <option value="isya">Isya</option>
            </select>
            <select id="lokasi"></select>
            <div class="input-group"><input id="qab" placeholder="Nama Petugas Utama"><button class="btn-test" onclick="testVoice('qab')">ðŸ“¢ Tes</button></div>
            <div class="input-group hidden" id="group-bad"><input id="bad" placeholder="Nama Petugas Tambahan"><button class="btn-test" onclick="testVoice('bad')">ðŸ“¢ Tes</button></div>
        </div>
        <button id="mainPlay" onclick="play()">â–¶ Siarkan Pengumuman</button>
    </div>

    <div class="log-section">
        <h3>ðŸ“‹ Log Petugas</h3>
        <div class="log-container"><table id="logTable"><tbody></tbody></table></div>
    </div>
</div>

<audio id="rekaman" referrerpolicy="no-referrer"></audio>

<script>
    const audioTag = document.getElementById("rekaman");
    const viz = document.getElementById("viz");
    const btnPlay = document.getElementById("mainPlay");

    // Update Waktu
    function updateDateTime() {
        const now = new Date();
        document.getElementById('realtime-date').innerText = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('realtime-clock').innerText = now.toLocaleTimeString('id-ID', { hour12: false });
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    function aturForm(){
        const s = document.getElementById("sholat").value;
        document.getElementById("lokasi").innerHTML = (s==="subuh" || s==="dzuhur") ? 
            "<option value='Masjid AHC'>Masjid AHC</option>" : 
            "<option value='Lantai 1'>Lantai 1</option><option value='Lantai 2'>Lantai 2</option>";
        document.getElementById("group-bad").classList.toggle("hidden", !(s==="dzuhur" || s==="isya"));
    }

    // Fungsi Inti Putar Audio (Bypass CORS)
    async function putarAudio(url) {
        return new Promise((resolve) => {
            // Gunakan objek Audio baru untuk Google TTS agar tidak kena CORS policy
            let player = url.includes("google") ? new Audio() : audioTag;
            
            player.src = url;
            player.referrerPolicy = "no-referrer";
            
            player.play().then(() => {
                viz.classList.add("active");
            }).catch(e => {
                console.error("Gagal putar suara:", e);
                resolve();
            });

            player.onended = () => {
                viz.classList.remove("active");
                resolve();
            };

            player.onerror = () => {
                console.error("Error pada file:", url);
                viz.classList.remove("active");
                resolve();
            };
        });
    }

    function getTTS(teks) {
        return `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(teks)}&tl=id&client=tw-ob&ttsspeed=1`;
    }

    async function testVoice(id) {
        const val = document.getElementById(id).value;
        if(!val) return alert("Isi nama dulu!");
        await putarAudio(getTTS(val));
    }

    async function play() {
        const s = document.getElementById("sholat").value;
        const q = document.getElementById("qab").value;
        const b = document.getElementById("bad").value;
        if(!s || !q) return alert("Data tidak lengkap!");

        btnPlay.disabled = true;
        btnPlay.innerText = "MENYIARKAN...";

        const l = document.getElementById("lokasi").value;
        let queue = ["audio/bel.mp3"];

        // Logika Antrean
        if(s==="subuh") queue.push("audio/subuh.mp3", q);
        else if(s==="dzuhur") queue.push("audio/dzuhur_qab.mp3", q, "audio/dzuhur_bad.mp3", b);
        else if(s==="ashar" || s==="maghrib") {
            queue.push(`audio/${s}.mp3`, (l==="Lantai 1" ? "audio/lantai1.mp3" : "audio/lantai2.mp3"), q);
        }
        else if(s==="isya") {
            queue.push("audio/isya_qab.mp3", (l==="Lantai 1" ? "audio/lantai1.mp3" : "audio/lantai2.mp3"), q, "audio/isya_bad.mp3", b);
        }

        queue.push("audio/penutup.mp3");

        for (let item of queue.filter(Boolean)) {
            let path = item.endsWith(".mp3") ? item : getTTS(item);
            await putarAudio(path);
            await new Promise(r => setTimeout(r, 600));
        }

        btnPlay.disabled = false;
        btnPlay.innerText = "â–¶ Siarkan Pengumuman";
        tambahLog(s, q);
    }

    function tambahLog(s, q) {
        const table = document.getElementById("logTable").getElementsByTagName('tbody')[0];
        const row = table.insertRow(0);
        const jam = new Date().toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
        row.innerHTML = `<td>${jam}</td><td><span class="badge">${s.toUpperCase()}</span></td><td style="font-weight:600">${q}</td>`;
    }

    // Ambil Jadwal Adzan
    fetch("https://api.aladhan.com/v1/timingsByCity?city=Sleman&country=Indonesia&method=20")
    .then(r=>r.json()).then(d=>{
        const t=d.data.timings;
        document.getElementById("t-fajr").innerText = t.Fajr;
        document.getElementById("t-dhuhr").innerText = t.Dhuhr;
        document.getElementById("t-asr").innerText = t.Asr;
        document.getElementById("t-maghrib").innerText = t.Maghrib;
        document.getElementById("t-isha").innerText = t.Isha;
    });
</script>
</body>
</html>
